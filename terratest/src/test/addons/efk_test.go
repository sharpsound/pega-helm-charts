package addons

import (
	"github.com/stretchr/testify/require"
	"k8s.io/api/apps/v1beta2"
	v1 "k8s.io/api/core/v1"
	"k8s.io/api/extensions/v1beta1"
	"test/common"
	"testing"
)

func TestShouldNotContainDeploy_EFKIfDisabled(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"elasticsearch.enabled":         "false",
			"kibana.enabled":                "false",
			"fluentd-elasticsearch.enabled": "false",
		}),
	)

	for _, i := range deployEfkResources {
		require.False(t, helmChartParser.Contains(common.SearchResourceOption{
			Name: i.Name,
			Kind: i.Kind,
		}))
	}
}
func TestShouldDeploy_EFKContainAllResourcesIfEnabled(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"elasticsearch.enabled":         "true",
			"kibana.enabled":                "true",
			"fluentd-elasticsearch.enabled": "true",
		}),
	)

	for _, i := range deployEfkResources {
		require.True(t, helmChartParser.Contains(common.SearchResourceOption{
			Name: i.Name,
			Kind: i.Kind,
		}))
	}
}

func Test_shouldBeFullnameOverrideForElasticsearch(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"elasticsearch.enabled": "true",
		}),
	)
	require.True(t, helmChartParser.Contains(common.SearchResourceOption{
		Name: "elastic-search",
		Kind: "ConfigMap",
	}))
}

func Test_shouldBeElasticSearchUrlForKibana(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"kibana.enabled": "true",
			"kibana.files.kibana.yml.elasticsearch.url": "http://elastic-search-client:9200",
		}),
	)

	var configmap *v1.ConfigMap
	helmChartParser.Find(common.SearchResourceOption{
		Name: "release-name-kibana",
		Kind: "ConfigMap",
	}, &configmap)

	require.Contains(t, configmap.Data["kibana.yml"], "http://elastic-search-client:9200")
}
func Test_shouldBeServiceExternalPortForKibana(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"kibana.enabled":              "true",
			"kibana.service.externalPort": "80",
		}),
	)

	var service *v1.Service
	helmChartParser.Find(common.SearchResourceOption{
		Name: "release-name-kibana",
		Kind: "Service",
	}, &service)

	require.Equal(t, int32(80), service.Spec.Ports[0].Port)
}

func Test_shouldBeIngressEnabledForKibana(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"kibana.enabled":         "true",
			"kibana.ingress.enabled": "true",
		}),
	)

	require.True(t, helmChartParser.Contains(common.SearchResourceOption{
		Name: "release-name-kibana",
		Kind: "Ingress",
	}))
}

func Test_shouldBeIngressDisabledForKibana(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"kibana.enabled":         "true",
			"kibana.ingress.enabled": "false",
		}),
	)

	require.False(t, helmChartParser.Contains(common.SearchResourceOption{
		Name: "release-name-kibana",
		Kind: "Ingress",
	}))
}

func Test_shouldBeHostForIngressKibana(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"kibana.enabled":         "true",
			"kibana.ingress.enabled": "true",
			"kibana.ingress.hosts":   "{YOUR_WEB.KIBANA.EXAMPLE.COM}",
		}),
	)

	var ingress *v1beta1.Ingress
	helmChartParser.Find(common.SearchResourceOption{
		Name: "release-name-kibana",
		Kind: "Ingress",
	}, &ingress)

	require.Contains(t, ingress.Spec.Rules[0].Host, "YOUR_WEB.KIBANA.EXAMPLE.COM")

}
func Test_shouldBeHostForElasticsearch(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"fluentd-elasticsearch.enabled": "true",
			"elasticsearch.host":            "elastic-search-client",
		}),
	)

	var daemon *v1beta2.DaemonSet
	helmChartParser.Find(common.SearchResourceOption{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "DaemonSet",
	}, &daemon)

	require.Equal(t, "elastic-search-client", daemon.Spec.Template.Spec.Containers[0].Env[1].Value)
}

func Test_shouldBeBufferChunkLimitForElasticsearch(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"fluentd-elasticsearch.enabled":    "true",
			"elasticsearch.buffer_chunk_limit": "250M",
		}),
	)

	var daemon *v1beta2.DaemonSet
	helmChartParser.Find(common.SearchResourceOption{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "DaemonSet",
	}, &daemon)

	require.Equal(t, "250M", daemon.Spec.Template.Spec.Containers[0].Env[4].Value)
}

func Test_shouldBeBufferQueueLimitForElasticsearch(t *testing.T) {
	helmChartParser := common.NewHelmConfigParser(
		common.NewHelmTest(t, helmChartRelativePath, map[string]string{
			"fluentd-elasticsearch.enabled":    "true",
			"elasticsearch.buffer_queue_limit": "30",
		}),
	)

	var daemon *v1beta2.DaemonSet
	helmChartParser.Find(common.SearchResourceOption{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "DaemonSet",
	}, &daemon)

	require.Equal(t, "30", daemon.Spec.Template.Spec.Containers[0].Env[5].Value)
}

var deployEfkResources = []common.SearchResourceOption{
	{
		Name: "release-name-kibana",
		Kind: "ConfigMap",
	},
	{
		Name: "release-name-kibana",
		Kind: "Service",
	},
	{
		Name: "release-name-kibana",
		Kind: "Deployment",
	},
	{
		Name: "elastic-search",
		Kind: "ConfigMap",
	},
	{
		Name: "elastic-search-data",
		Kind: "StatefulSet",
	},
	{
		Name: "elastic-search-master",
		Kind: "StatefulSet",
	},
	{
		Name: "elastic-search-client",
		Kind: "ServiceAccount",
	},
	{
		Name: "elastic-search-data",
		Kind: "ServiceAccount",
	},
	{
		Name: "elastic-search-master",
		Kind: "ServiceAccount",
	},
	{
		Name: "elastic-search-client",
		Kind: "Service",
	},
	{
		Name: "elastic-search-discovery",
		Kind: "Service",
	},
	{
		Name: "elastic-search-client",
		Kind: "Deployment",
	},
	{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "ConfigMap",
	},
	{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "ServiceAccount",
	},
	{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "ClusterRole",
	},
	{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "ClusterRoleBinding",
	},
	{
		Name: "release-name-fluentd-elasticsearch",
		Kind: "DaemonSet",
	},
}
